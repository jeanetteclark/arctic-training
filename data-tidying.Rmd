---
title: "Data Tidying"
author: "Jeanette Clark"
date: "1/16/2019"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r, warning = F, message = F}
library(dplyr)
library(tidyr)
```

to call a function from a specific package `package_name::function_name(...)`

# Data Cleaning

Read in data file

```{r}
catch_df <- read.csv(url("https://knb.ecoinformatics.org/knb/d1/mn/v2/object/df35b.302.1", 
                         method = "libcurl"),
                    stringsAsFactors = FALSE)
head(catch_df)
```

cmd + shift + m %>% pipe operator

* Remove marginal sum and notes column
* Move from wide to long format

```{r}
catch_long <- catch_df %>%
  # negative values remove columns
  select(-All, -notesRegCode) %>% 
  gather(key = "species", value = "catch", -Year, -Region)
  
  
head(catch_long)
```


* erroneous value due to OCR issue - change "I" to one
* create catch column in correct units


```{r}
catch_cleaned <- catch_long %>% 
  rename(catch_thousands = catch) %>%
  mutate(catch_thousands = ifelse(catch_thousands == "I", 1, catch_thousands)) %>% 
  mutate(catch_thousands = as.integer(catch_thousands)) %>% 
  mutate(catch = catch_thousands * 1000)

tail(catch_cleaned)


```
 
 
```{r, eval = F, echo = F}
# I used this code to find the bad value
test_catch <- as.integer(catch_cleaned$catch_thousands)

i <- which(is.na(test_catch) == T)

catch_cleaned[i, ]

```

# Split-Apply-Combine


Calculate total catch by region

```{r}
catch_total <- catch_cleaned %>% 
  group_by(Region, Year) %>% 
  summarize(catch_region = sum(catch), 
            n_obs = n())

catch_total
```

Matt's Challenge

```{r}
catch_matt <- catch_cleaned %>% 
  group_by(species, Year) %>% 
  summarize(catch_mean = mean(catch), # calculate mean
            catch_sd = sd(catch),
            catch_n = n()) # total observations

head(catch_matt)
```

Filter for chinook salmon

| or operator

```{r}
catch_chinook <- catch_cleaned %>% 
  filter(species == "Chinook" & Region == "SSE" & Year > 1990) %>% 
  arrange(-Year)

head(catch_chinook)
```


# Joins

Read in region definitions files

```{r}
region_defs <- read.csv(url("https://knb.ecoinformatics.org/knb/d1/mn/v2/object/df35b.303.1", method = "libcurl"),
                        stringsAsFactors = FALSE)

head(region_defs)
```
Clean up region definitions data

```{r}
region_clean <- region_defs %>% 
  select(code, mgmtArea)

head(region_clean)

```

```{r}

catch_joined <- left_join(catch_cleaned, region_clean, 
                          by = c("Region" = "code"))


head(catch_joined)
test <- c("Region" = "code")
```



